<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>套接字（socket） | nanarino note</title>
    <meta name="description" content="a note I took with markdown">
    
    
    <link rel="preload" href="/markdown-note/assets/css/0.styles.447f505d.css" as="style"><link rel="preload" href="/markdown-note/assets/js/app.6e2a47d9.js" as="script"><link rel="preload" href="/markdown-note/assets/js/8.09685a99.js" as="script"><link rel="prefetch" href="/markdown-note/assets/js/10.8545fbf1.js"><link rel="prefetch" href="/markdown-note/assets/js/11.c591ac1f.js"><link rel="prefetch" href="/markdown-note/assets/js/12.38d44553.js"><link rel="prefetch" href="/markdown-note/assets/js/13.c74d45f6.js"><link rel="prefetch" href="/markdown-note/assets/js/14.bab4a9fb.js"><link rel="prefetch" href="/markdown-note/assets/js/15.9ad785ce.js"><link rel="prefetch" href="/markdown-note/assets/js/16.563203ba.js"><link rel="prefetch" href="/markdown-note/assets/js/17.6dcf9869.js"><link rel="prefetch" href="/markdown-note/assets/js/18.ac2c5815.js"><link rel="prefetch" href="/markdown-note/assets/js/19.5a90d5c6.js"><link rel="prefetch" href="/markdown-note/assets/js/2.2208a19d.js"><link rel="prefetch" href="/markdown-note/assets/js/20.d2c1e60b.js"><link rel="prefetch" href="/markdown-note/assets/js/21.cdef5b11.js"><link rel="prefetch" href="/markdown-note/assets/js/22.14104b6c.js"><link rel="prefetch" href="/markdown-note/assets/js/23.df9abc21.js"><link rel="prefetch" href="/markdown-note/assets/js/24.e883d23b.js"><link rel="prefetch" href="/markdown-note/assets/js/25.80a679f4.js"><link rel="prefetch" href="/markdown-note/assets/js/26.f446d7f7.js"><link rel="prefetch" href="/markdown-note/assets/js/27.1e02f8bd.js"><link rel="prefetch" href="/markdown-note/assets/js/28.5f3d3747.js"><link rel="prefetch" href="/markdown-note/assets/js/29.b230f9f7.js"><link rel="prefetch" href="/markdown-note/assets/js/3.e0813aed.js"><link rel="prefetch" href="/markdown-note/assets/js/30.70c83e7c.js"><link rel="prefetch" href="/markdown-note/assets/js/31.4a50e074.js"><link rel="prefetch" href="/markdown-note/assets/js/32.9ccdcc5f.js"><link rel="prefetch" href="/markdown-note/assets/js/33.fb6dc097.js"><link rel="prefetch" href="/markdown-note/assets/js/34.967ab631.js"><link rel="prefetch" href="/markdown-note/assets/js/35.f06c88b4.js"><link rel="prefetch" href="/markdown-note/assets/js/4.891a686e.js"><link rel="prefetch" href="/markdown-note/assets/js/5.2f006642.js"><link rel="prefetch" href="/markdown-note/assets/js/6.d00ca5cf.js"><link rel="prefetch" href="/markdown-note/assets/js/7.7b8107dc.js"><link rel="prefetch" href="/markdown-note/assets/js/9.215f5681.js">
    <link rel="stylesheet" href="/markdown-note/assets/css/0.styles.447f505d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/markdown-note/" class="home-link router-link-active"><!----> <span class="site-name">nanarino note</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/markdown-note/py/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><a href="/markdown-note/js/" class="nav-link">JavaScript</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/nanarino/markdown-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.akokono.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mysite
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/markdown-note/py/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><a href="/markdown-note/js/" class="nav-link">JavaScript</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/nanarino/markdown-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.akokono.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mysite
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>起步</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据类型</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>函数</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>常用模块</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面向对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>网络编程</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/markdown-note/py/27-网络编程基础.html" class="sidebar-link">补课:计算机网络</a></li><li><a href="/markdown-note/py/28-套接字socket.html" class="active sidebar-link">套接字（socket）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/markdown-note/py/29-黏包.html" class="sidebar-link">黏包</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="套接字（socket）"><a href="#套接字（socket）" aria-hidden="true" class="header-anchor">#</a> 套接字（socket）</h1> <blockquote><p>套接字起源于 20 世纪 70 年代加利福尼亚大学伯克利分校版本的 Unix,即人们所说的 BSD Unix。 因此,有时人们也把套接字称为“伯克利套接字”或“BSD 套接字”。一开始,套接字被设计用在同 一台主机上多个应用程序之间的通讯。这也被称进程间通讯,或 IPC。套接字有两种（或者称为有两个种族）,分别是基于文件型的和基于网络型的。</p></blockquote> <h1 id="基于tcp协议的socket"><a href="#基于tcp协议的socket" aria-hidden="true" class="header-anchor">#</a> 基于TCP协议的socket</h1> <h3 id="server端"><a href="#server端" aria-hidden="true" class="header-anchor">#</a> server端</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8898</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#把地址绑定到套接字</span>
sk<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment">#监听链接</span>
conn<span class="token punctuation">,</span>addr <span class="token operator">=</span> sk<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#接受客户端链接</span>
ret <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment">#接收客户端信息</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>       <span class="token comment">#打印客户端信息</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'hi'</span><span class="token punctuation">)</span>        <span class="token comment">#向客户端发送信息</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">#关闭客户端套接字</span>
sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">#关闭服务器套接字(可选)</span>
</code></pre></div><h3 id="client端"><a href="#client端" aria-hidden="true" class="header-anchor">#</a> client端</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment"># 创建客户套接字</span>
sk<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8898</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 尝试连接服务器</span>
sk<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'hello!'</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> sk<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>         <span class="token comment"># 对话(发送/接收)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 关闭客户套接字</span>
</code></pre></div><h3 id="在重启服务端时可能会遇到"><a href="#在重启服务端时可能会遇到" aria-hidden="true" class="header-anchor">#</a> 在重启服务端时可能会遇到</h3> <p><img src="/markdown-note/assets/img/socket1.7d33a572.png" alt="img">解决方法：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#加入一条socket配置，重用ip和端口</span>
<span class="token keyword">import</span> socket
<span class="token keyword">from</span> socket <span class="token keyword">import</span> SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#就是它，在bind前加</span>
sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8898</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#把地址绑定到套接字</span>
sk<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment">#监听链接</span>
conn<span class="token punctuation">,</span>addr <span class="token operator">=</span> sk<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#接受客户端链接</span>
ret <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>   <span class="token comment">#接收客户端信息</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>              <span class="token comment">#打印客户端信息</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'hi'</span><span class="token punctuation">)</span>        <span class="token comment">#向客户端发送信息</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">#关闭客户端套接字</span>
sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">#关闭服务器套接字(可选)</span>
</code></pre></div><h1 id="基于udp协议的socket"><a href="#基于udp协议的socket" aria-hidden="true" class="header-anchor">#</a> 基于UDP协议的socket</h1> <h4 id="server端-2"><a href="#server端-2" aria-hidden="true" class="header-anchor">#</a> server端</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket
udp_sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span>socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>   <span class="token comment">#创建一个服务器的套接字</span>
udp_sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">#绑定服务器套接字</span>
msg<span class="token punctuation">,</span>addr <span class="token operator">=</span> udp_sk<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
udp_sk<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span><span class="token string">b'hi'</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span>                 <span class="token comment"># 对话(接收与发送)</span>
udp_sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment"># 关闭服务器套接字</span>
</code></pre></div><h4 id="client端-2"><a href="#client端-2" aria-hidden="true" class="header-anchor">#</a> client端</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket
ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">9000</span><span class="token punctuation">)</span>
udp_sk<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span>socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>
udp_sk<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span><span class="token string">b'hello'</span><span class="token punctuation">,</span>ip_port<span class="token punctuation">)</span>
back_msg<span class="token punctuation">,</span>addr<span class="token operator">=</span>udp_sk<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>back_msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span>
</code></pre></div><h3 id="更多方法介绍"><a href="#更多方法介绍" aria-hidden="true" class="header-anchor">#</a> 更多方法介绍</h3> <div class="language-txt extra-class"><pre class="language-text"><code>服务端套接字函数
s.bind()    绑定(主机,端口号)到套接字
s.listen()  开始TCP监听
s.accept()  被动接受TCP客户的连接,(阻塞式)等待连接的到来

客户端套接字函数
s.connect()     主动初始化TCP服务器连接
s.connect_ex()  connect()函数的扩展版本,出错时返回出错码,而不是抛出异常

公共用途的套接字函数
s.recv()            接收TCP数据
s.send()            发送TCP数据
s.sendall()         发送TCP数据
s.recvfrom()        接收UDP数据
s.sendto()          发送UDP数据
s.getpeername()     连接到当前套接字的远端的地址
s.getsockname()     当前套接字的地址
s.getsockopt()      返回指定套接字的参数
s.setsockopt()      设置指定套接字的参数
s.close()           关闭套接字

面向锁的套接字方法
s.setblocking()     设置套接字的阻塞与非阻塞模式
s.settimeout()      设置阻塞套接字操作的超时时间
s.gettimeout()      得到阻塞套接字操作的超时时间

面向文件的套接字的函数
s.fileno()          套接字的文件描述符
s.makefile()        创建一个与该套接字相关的文件
</code></pre></div><p>官方文档对socket模块下的socket.send()和socket.sendall()解释如下：</p> <div class="language-txt extra-class"><pre class="language-text"><code>socket.send(string[, flags])
Send data to the socket. The socket must be connected to a remote socket. The optional flags argument has the same meaning as for recv() above. Returns the number of bytes sent. Applications are responsible for checking that all data has been sent; if only some of the data was transmitted, the application needs to attempt delivery of the remaining data.

send()的返回值是发送的字节数量，这个数量值可能小于要发送的string的字节数，也就是说可能无法发送string中所有的数据。如果有错误则会抛出异常。

–

socket.sendall(string[, flags])
Send data to the socket. The socket must be connected to a remote socket. The optional flags argument has the same meaning as for recv() above. Unlike send(), this method continues to send data from string until either all data has been sent or an error occurs. None is returned on success. On error, an exception is raised, and there is no way to determine how much data, if any, was successfully sent.

尝试发送string的所有数据，成功则返回None，失败则抛出异常。

故，下面两段代码是等价的：

#sock.sendall('Hello world\n')

#buffer = 'Hello world\n'
#while buffer:
#    bytes = sock.send(buffer)
#    buffer = buffer[bytes:]
</code></pre></div><h4 id="验证客户端链接的合法性"><a href="#验证客户端链接的合法性" aria-hidden="true" class="header-anchor">#</a> 验证客户端链接的合法性</h4> <p>如果你想在分布式系统中实现一个简单的客户端链接认证功能，又不像SSL那么复杂，那么利用hmac+加盐的方式来实现</p> <p>服务端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> hmac<span class="token punctuation">,</span>os

secret_key<span class="token operator">=</span><span class="token string">b'linhaifeng bang bang bang'</span>
<span class="token keyword">def</span> <span class="token function">conn_auth</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    认证客户端链接
    :param conn:
    :return:
    '''</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始验证新链接的合法性'</span><span class="token punctuation">)</span>
    msg<span class="token operator">=</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    h<span class="token operator">=</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>secret_key<span class="token punctuation">,</span>msg<span class="token punctuation">)</span>
    digest<span class="token operator">=</span>h<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    respone<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> hmac<span class="token punctuation">.</span>compare_digest<span class="token punctuation">(</span>respone<span class="token punctuation">,</span>digest<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">data_handler</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span>bufsize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> conn_auth<span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'该链接不合法,关闭'</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接合法,开始通信'</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>bufsize<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span><span class="token keyword">break</span>
        conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">server_handler</span><span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token punctuation">,</span>backlog<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    只处理链接
    :param ip_port:
    :return:
    '''</span>
    tcp_socket_server<span class="token operator">=</span>socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">)</span>
    tcp_socket_server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>ip_port<span class="token punctuation">)</span>
    tcp_socket_server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span>backlog<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span>addr<span class="token operator">=</span>tcp_socket_server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'新连接[%s:%s]'</span> <span class="token operator">%</span><span class="token punctuation">(</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data_handler<span class="token punctuation">(</span>conn<span class="token punctuation">,</span>bufsize<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
    bufsize<span class="token operator">=</span><span class="token number">1024</span>
    server_handler<span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token punctuation">)</span>
</code></pre></div><p>客户端(合法)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
__author__ <span class="token operator">=</span> <span class="token string">'Linhaifeng'</span>
<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> hmac<span class="token punctuation">,</span>os

secret_key<span class="token operator">=</span><span class="token string">b'linhaifeng bang bang bang'</span>
<span class="token keyword">def</span> <span class="token function">conn_auth</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    验证客户端到服务器的链接
    :param conn:
    :return:
    '''</span>
    msg<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
    h<span class="token operator">=</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>secret_key<span class="token punctuation">,</span>msg<span class="token punctuation">)</span>
    digest<span class="token operator">=</span>h<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>digest<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">client_handler</span><span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp_socket_client<span class="token operator">=</span>socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">)</span>
    tcp_socket_client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>ip_port<span class="token punctuation">)</span>

    conn_auth<span class="token punctuation">(</span>tcp_socket_client<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span><span class="token keyword">continue</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">'quit'</span><span class="token punctuation">:</span><span class="token keyword">break</span>

        tcp_socket_client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        respone<span class="token operator">=</span>tcp_socket_client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>bufsize<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>respone<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp_socket_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
    bufsize<span class="token operator">=</span><span class="token number">1024</span>
    client_handler<span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token punctuation">)</span>
</code></pre></div><p>客户端(非法:不知道加密方式)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
__author__ <span class="token operator">=</span> <span class="token string">'Linhaifeng'</span>
<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">client_handler</span><span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp_socket_client<span class="token operator">=</span>socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">)</span>
    tcp_socket_client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>ip_port<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span><span class="token keyword">continue</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">'quit'</span><span class="token punctuation">:</span><span class="token keyword">break</span>

        tcp_socket_client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        respone<span class="token operator">=</span>tcp_socket_client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>bufsize<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>respone<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp_socket_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
    bufsize<span class="token operator">=</span><span class="token number">1024</span>
    client_handler<span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token punctuation">)</span>
</code></pre></div><p>客户端(非法:不知道secret_key)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
__author__ <span class="token operator">=</span> <span class="token string">'Linhaifeng'</span>
<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> hmac<span class="token punctuation">,</span>os

secret_key<span class="token operator">=</span><span class="token string">b'linhaifeng bang bang bang1111'</span>
<span class="token keyword">def</span> <span class="token function">conn_auth</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    验证客户端到服务器的链接
    :param conn:
    :return:
    '''</span>
    msg<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
    h<span class="token operator">=</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>secret_key<span class="token punctuation">,</span>msg<span class="token punctuation">)</span>
    digest<span class="token operator">=</span>h<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>digest<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">client_handler</span><span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp_socket_client<span class="token operator">=</span>socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">)</span>
    tcp_socket_client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>ip_port<span class="token punctuation">)</span>

    conn_auth<span class="token punctuation">(</span>tcp_socket_client<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span><span class="token keyword">continue</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">'quit'</span><span class="token punctuation">:</span><span class="token keyword">break</span>

        tcp_socket_client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        respone<span class="token operator">=</span>tcp_socket_client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>bufsize<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>respone<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp_socket_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
    bufsize<span class="token operator">=</span><span class="token number">1024</span>
    client_handler<span class="token punctuation">(</span>ip_port<span class="token punctuation">,</span>bufsize<span class="token punctuation">)</span>
</code></pre></div><h3 id="socketserver模块"><a href="#socketserver模块" aria-hidden="true" class="header-anchor">#</a> socketserver模块</h3> <p>server端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socketserver
<span class="token keyword">class</span> <span class="token class-name">Myserver</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;{} wrote:&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    HOST<span class="token punctuation">,</span> PORT <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span>

    <span class="token comment"># 设置allow_reuse_address允许服务器重用地址</span>
    socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">.</span>allow_reuse_address <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token comment"># 创建一个server, 将服务地址绑定到127.0.0.1:9999</span>
    server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span>Myserver<span class="token punctuation">)</span>
    <span class="token comment"># 让server永远运行下去，除非强制停止程序</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>client端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket

HOST<span class="token punctuation">,</span> PORT <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span>
data <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>

<span class="token comment"># 创建一个socket链接，SOCK_STREAM代表使用TCP协议</span>
<span class="token keyword">with</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> <span class="token keyword">as</span> sock<span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment"># 链接到客户端</span>
    sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 向服务端发送数据</span>
    received <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token comment"># 从服务端接收数据</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Sent:     {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Received: {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>received<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/markdown-note/assets/js/app.6e2a47d9.js" defer></script><script src="/markdown-note/assets/js/8.09685a99.js" defer></script>
  </body>
</html>
