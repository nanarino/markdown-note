<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>闭包和装饰器 | nanarino note</title>
    <meta name="description" content="a note I took with markdown">
    
    
    <link rel="preload" href="/markdown-note/assets/css/0.styles.447f505d.css" as="style"><link rel="preload" href="/markdown-note/assets/js/app.fdab574b.js" as="script"><link rel="preload" href="/markdown-note/assets/js/38.9b6814a4.js" as="script"><link rel="prefetch" href="/markdown-note/assets/js/10.c36c8c99.js"><link rel="prefetch" href="/markdown-note/assets/js/11.3ca32aa8.js"><link rel="prefetch" href="/markdown-note/assets/js/12.431aa9de.js"><link rel="prefetch" href="/markdown-note/assets/js/13.3a3307fa.js"><link rel="prefetch" href="/markdown-note/assets/js/14.26e3e81e.js"><link rel="prefetch" href="/markdown-note/assets/js/15.23bf0b11.js"><link rel="prefetch" href="/markdown-note/assets/js/16.0a3923a4.js"><link rel="prefetch" href="/markdown-note/assets/js/17.7f4a17ab.js"><link rel="prefetch" href="/markdown-note/assets/js/18.519ebe17.js"><link rel="prefetch" href="/markdown-note/assets/js/19.71fee398.js"><link rel="prefetch" href="/markdown-note/assets/js/2.2789741e.js"><link rel="prefetch" href="/markdown-note/assets/js/20.594efd53.js"><link rel="prefetch" href="/markdown-note/assets/js/21.502a6ee3.js"><link rel="prefetch" href="/markdown-note/assets/js/22.20ef2aa3.js"><link rel="prefetch" href="/markdown-note/assets/js/23.d211eb36.js"><link rel="prefetch" href="/markdown-note/assets/js/24.84b7faf2.js"><link rel="prefetch" href="/markdown-note/assets/js/25.703f8284.js"><link rel="prefetch" href="/markdown-note/assets/js/26.4be501d5.js"><link rel="prefetch" href="/markdown-note/assets/js/27.b1a35819.js"><link rel="prefetch" href="/markdown-note/assets/js/28.4158d6ab.js"><link rel="prefetch" href="/markdown-note/assets/js/29.526d0b0e.js"><link rel="prefetch" href="/markdown-note/assets/js/3.dcb0755e.js"><link rel="prefetch" href="/markdown-note/assets/js/30.4e5c0e62.js"><link rel="prefetch" href="/markdown-note/assets/js/31.fca647f8.js"><link rel="prefetch" href="/markdown-note/assets/js/32.ba6e2f1c.js"><link rel="prefetch" href="/markdown-note/assets/js/33.4f58275c.js"><link rel="prefetch" href="/markdown-note/assets/js/34.672326bf.js"><link rel="prefetch" href="/markdown-note/assets/js/35.66d3e1f1.js"><link rel="prefetch" href="/markdown-note/assets/js/36.f29b9098.js"><link rel="prefetch" href="/markdown-note/assets/js/37.f6560079.js"><link rel="prefetch" href="/markdown-note/assets/js/39.1df0c5a4.js"><link rel="prefetch" href="/markdown-note/assets/js/4.09533aa5.js"><link rel="prefetch" href="/markdown-note/assets/js/40.31824979.js"><link rel="prefetch" href="/markdown-note/assets/js/41.8e04bc8d.js"><link rel="prefetch" href="/markdown-note/assets/js/42.4b04cdd0.js"><link rel="prefetch" href="/markdown-note/assets/js/43.225c8dca.js"><link rel="prefetch" href="/markdown-note/assets/js/44.c22e6464.js"><link rel="prefetch" href="/markdown-note/assets/js/45.73d25276.js"><link rel="prefetch" href="/markdown-note/assets/js/46.e540f4a1.js"><link rel="prefetch" href="/markdown-note/assets/js/47.81668c7e.js"><link rel="prefetch" href="/markdown-note/assets/js/48.dde28177.js"><link rel="prefetch" href="/markdown-note/assets/js/49.d1743fa7.js"><link rel="prefetch" href="/markdown-note/assets/js/5.561a8061.js"><link rel="prefetch" href="/markdown-note/assets/js/50.2dd70af8.js"><link rel="prefetch" href="/markdown-note/assets/js/51.d0b49bc5.js"><link rel="prefetch" href="/markdown-note/assets/js/52.a1767f9a.js"><link rel="prefetch" href="/markdown-note/assets/js/53.d2fe04ba.js"><link rel="prefetch" href="/markdown-note/assets/js/54.5b7d8206.js"><link rel="prefetch" href="/markdown-note/assets/js/55.2151c6bc.js"><link rel="prefetch" href="/markdown-note/assets/js/56.33defd83.js"><link rel="prefetch" href="/markdown-note/assets/js/57.c620ea9d.js"><link rel="prefetch" href="/markdown-note/assets/js/58.6d52ed55.js"><link rel="prefetch" href="/markdown-note/assets/js/59.d38e2a81.js"><link rel="prefetch" href="/markdown-note/assets/js/6.2ffce86f.js"><link rel="prefetch" href="/markdown-note/assets/js/60.18a119b0.js"><link rel="prefetch" href="/markdown-note/assets/js/61.1af48434.js"><link rel="prefetch" href="/markdown-note/assets/js/62.0c01b951.js"><link rel="prefetch" href="/markdown-note/assets/js/63.b0eed8fb.js"><link rel="prefetch" href="/markdown-note/assets/js/7.6d1f0fd6.js"><link rel="prefetch" href="/markdown-note/assets/js/8.2d84ec2c.js"><link rel="prefetch" href="/markdown-note/assets/js/9.9f38b659.js">
    <link rel="stylesheet" href="/markdown-note/assets/css/0.styles.447f505d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/markdown-note/" class="home-link router-link-active"><!----> <span class="site-name">nanarino note</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/markdown-note/js/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/markdown-note/py/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/nanarino/markdown-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.akokono.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mysite
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/markdown-note/js/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/markdown-note/py/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/nanarino/markdown-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.akokono.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mysite
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>起步</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据类型</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>函数</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/markdown-note/py/7-文件处理.html" class="sidebar-link">文件处理</a></li><li><a href="/markdown-note/py/8-函数和作用域.html" class="sidebar-link">函数和作用域</a></li><li><a href="/markdown-note/py/9-深浅拷贝.html" class="sidebar-link">深浅拷贝</a></li><li><a href="/markdown-note/py/10-闭包和装饰器.html" class="active sidebar-link">闭包和装饰器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/markdown-note/py/10-闭包和装饰器.html#闭包" class="sidebar-link">闭包</a></li><li class="sidebar-sub-header"><a href="/markdown-note/py/10-闭包和装饰器.html#装饰器的实现" class="sidebar-link">装饰器的实现</a></li><li class="sidebar-sub-header"><a href="/markdown-note/py/10-闭包和装饰器.html#补充知识-递归" class="sidebar-link">补充知识:递归</a></li><li class="sidebar-sub-header"><a href="/markdown-note/py/10-闭包和装饰器.html#选修知识-尾递归" class="sidebar-link">选修知识:尾递归</a></li></ul></li><li><a href="/markdown-note/py/11-三目和列表解析.html" class="sidebar-link">三目和列表解析</a></li><li><a href="/markdown-note/py/12-迭代器和生成器.html" class="sidebar-link">迭代器和生成器</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>常用模块</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面向对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>网络编程</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>GUI编程</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>WEB框架</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="闭包和装饰器"><a href="#闭包和装饰器" aria-hidden="true" class="header-anchor">#</a> 闭包和装饰器</h1> <p>闭包是函数作用域的体现
装饰器本质就是函数,功能是为其他函数添加附加功能</p> <h2 id="闭包"><a href="#闭包" aria-hidden="true" class="header-anchor">#</a> 闭包</h2> <blockquote><p>闭包（Closure）是词法闭包（Lexical Closure）的简称，是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。所以，闭包是由函数和与其相关的引用环境组合而成的实体。</p> <p>闭包的原理，当内嵌函数引用了包含它的函数（enclosing function）中的non-local 变量后，这些变量会被保存在enclosing function的<code>__closure__</code>属性中，成为enclosing function本身的一部分；也就是说，这些变量的生命周期会和enclosing function一样。</p> <p>在Python中创建一个闭包可以归结为以下三点：</p> <ul><li>闭包函数必须有内嵌函数</li> <li>内嵌函数需要引用该嵌套函数上一级namespace中的变量</li> <li>闭包函数必须返回内嵌函数</li></ul></blockquote> <h4 id="闭包示例"><a href="#闭包示例" aria-hidden="true" class="header-anchor">#</a> 闭包示例</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    step<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">def</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">nonlocal</span> step
        step<span class="token operator">+=</span><span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span>
    <span class="token keyword">return</span> add1
<span class="token comment">#foo函数执行会返回一个累加作用的函数add1 </span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token comment">#函数执行结束作用域立即销毁 得利于python解释器的自动回收垃圾的机制</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a<span class="token operator">=</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b<span class="token operator">=</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> a<span class="token punctuation">.</span>__closure__<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> a<span class="token punctuation">.</span>__closure__<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cell_contents<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> a<span class="token punctuation">.</span>__closure__<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">3</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> 
<span class="token comment">#闭包让作用域不会被销毁 </span>
<span class="token comment">#__closure__属性拿到所引用的内部变量的内存地址（只做了解）</span>
</code></pre></div><h4 id="开放封闭原则"><a href="#开放封闭原则" aria-hidden="true" class="header-anchor">#</a> 开放封闭原则</h4> <blockquote><p>​    不修改被修饰函数的源代码
不修改被修改函数的调用方式</p></blockquote> <h2 id="装饰器的实现"><a href="#装饰器的实现" aria-hidden="true" class="header-anchor">#</a> 装饰器的实现</h2> <p>利用: <u>高阶函数</u>  和  <u>闭包</u></p> <p>装饰器名a</p> <p>被修饰的函数名b</p> <p>b声明的前一行<code>@a</code></p> <p>相当于<code>b=a(b)</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    code
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        code
        res<span class="token operator">=</span>func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        code
        <span class="token keyword">return</span> res
    <span class="token keyword">return</span> wrapper
    
@foo  
<span class="token keyword">def</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><h2 id="补充知识-递归"><a href="#补充知识-递归" aria-hidden="true" class="header-anchor">#</a> 补充知识:递归</h2> <blockquote><p>在计算机中，函数调用是通过栈（stack）这种数据结构实现的，每当进入一个函数调用，栈就会加一层栈帧，每当函数返回，栈就会减一层栈帧。由于栈的大小不是无限的，所以，递归调用的次数过多，会导致栈溢出。</p></blockquote> <p>递归实例:汉诺塔</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>home <span class="token operator">=</span> <span class="token string">&quot;A柱&quot;</span><span class="token punctuation">,</span>destination <span class="token operator">=</span> <span class="token string">&quot;C柱&quot;</span><span class="token punctuation">,</span>assistance <span class="token operator">=</span> <span class="token string">&quot;B柱&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">1</span> <span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\t将&quot;</span><span class="token operator">+</span> home <span class="token operator">+</span> <span class="token string">&quot;的最上面的环移动到&quot;</span> <span class="token operator">+</span> destination <span class="token operator">+</span> <span class="token string">&quot;的最上面&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> n<span class="token operator">&gt;</span><span class="token number">1</span> <span class="token punctuation">:</span>
        move<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>home<span class="token punctuation">,</span>assistance<span class="token punctuation">,</span>destination<span class="token punctuation">)</span>
        move<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>home<span class="token punctuation">,</span>destination<span class="token punctuation">,</span>assistance<span class="token punctuation">)</span>
        move<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>assistance<span class="token punctuation">,</span>destination<span class="token punctuation">,</span>home<span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> move<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	将A柱的最上面的环移动到C柱的最上面
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	将A柱的最上面的环移动到B柱的最上面
	将A柱的最上面的环移动到C柱的最上面
	将B柱的最上面的环移动到C柱的最上面
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> move<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
	将A柱的最上面的环移动到C柱的最上面
	将A柱的最上面的环移动到B柱的最上面
	将C柱的最上面的环移动到B柱的最上面
	将A柱的最上面的环移动到C柱的最上面
	将B柱的最上面的环移动到A柱的最上面
	将B柱的最上面的环移动到C柱的最上面
	将A柱的最上面的环移动到C柱的最上面
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> 
</code></pre></div><p>写一个装饰器来探究这个函数开辟了多少个作用域吧</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    step<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">nonlocal</span> step
        step<span class="token operator">+=</span><span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s个函数作用域被开辟&quot;</span><span class="token operator">%</span>step<span class="token punctuation">)</span>
        res<span class="token operator">=</span>func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s个函数作用域被销毁&quot;</span><span class="token operator">%</span>step<span class="token punctuation">)</span>
        step<span class="token operator">-=</span><span class="token number">1</span>
        <span class="token keyword">return</span> res
    <span class="token keyword">return</span> wrapper

@foo
<span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>home <span class="token operator">=</span> <span class="token string">&quot;A柱&quot;</span><span class="token punctuation">,</span>destination <span class="token operator">=</span> <span class="token string">&quot;C柱&quot;</span><span class="token punctuation">,</span>assistance <span class="token operator">=</span> <span class="token string">&quot;B柱&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">1</span> <span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\t将&quot;</span><span class="token operator">+</span> home <span class="token operator">+</span> <span class="token string">&quot;的最上面的环移动到&quot;</span> <span class="token operator">+</span> destination <span class="token operator">+</span> <span class="token string">&quot;的最上面&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> n<span class="token operator">&gt;</span><span class="token number">1</span> <span class="token punctuation">:</span>
        move<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>home<span class="token punctuation">,</span>assistance<span class="token punctuation">,</span>destination<span class="token punctuation">)</span>
        move<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>home<span class="token punctuation">,</span>destination<span class="token punctuation">,</span>assistance<span class="token punctuation">)</span>
        move<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>assistance<span class="token punctuation">,</span>destination<span class="token punctuation">,</span>home<span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> move<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
第<span class="token number">1</span>个函数作用域被开辟
	将A柱的最上面的环移动到C柱的最上面
第<span class="token number">1</span>个函数作用域被销毁
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
第<span class="token number">1</span>个函数作用域被开辟
第<span class="token number">2</span>个函数作用域被开辟
	将A柱的最上面的环移动到B柱的最上面
第<span class="token number">2</span>个函数作用域被销毁
第<span class="token number">2</span>个函数作用域被开辟
	将A柱的最上面的环移动到C柱的最上面
第<span class="token number">2</span>个函数作用域被销毁
第<span class="token number">2</span>个函数作用域被开辟
	将B柱的最上面的环移动到C柱的最上面
第<span class="token number">2</span>个函数作用域被销毁
第<span class="token number">1</span>个函数作用域被销毁
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> 
<span class="token comment">#由此可见 递归的性能消耗有多大</span>
</code></pre></div><h2 id="选修知识-尾递归"><a href="#选修知识-尾递归" aria-hidden="true" class="header-anchor">#</a> 选修知识:尾递归</h2> <blockquote><p>尾递归是指，在函数返回的时候，调用自身本身，并且，return语句不能包含表达式。这样，编译器或者解释器就可以把尾递归做优化，使递归本身无论调用多少次，都只占用一个栈帧，不会出现栈溢出的情况。</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#一般递归</span>
<span class="token keyword">def</span> <span class="token function">normal_recursion</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> n <span class="token operator">+</span> normal_recursion<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        
<span class="token comment">#尾递归</span>
<span class="token keyword">def</span> <span class="token function">tail_recursion</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> total
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> tail_recursion<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> total<span class="token operator">+</span>n<span class="token punctuation">)</span>
</code></pre></div><p>最后一步调用,形成&quot;调用栈&quot;</p> <p>复杂度 O(n) =&gt; O(1)</p> <p>遗憾的是，大多数编程语言没有针对尾递归做优化，Python解释器也没有做优化，所以，即使把上面的函数改成尾递归方式，也会导致栈溢出。</p> <p>​    但是一个牛人想出的解决办法：</p> <p><code>实现一个 tail_call_optimized 装饰器</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python2.4</span>
<span class="token comment"># This program shows off a python decorator(</span>
<span class="token comment"># which implements tail call optimization. It</span>
<span class="token comment"># does this by throwing an exception if it is</span>
<span class="token comment"># it's own grandparent, and catching such</span>
<span class="token comment"># exceptions to recall the stack.</span>

<span class="token keyword">import</span> sys

<span class="token keyword">class</span> <span class="token class-name">TailRecurseException</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs

<span class="token keyword">def</span> <span class="token function">tail_call_optimized</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    This function decorates a function with tail call
    optimization. It does this by throwing an exception
    if it is it's own grandparent, and catching such
    exceptions to fake the tail call optimization.

    This function fails if the decorated
    function recurses in a non-tail context.
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> sys<span class="token punctuation">.</span>_getframe<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> f<span class="token punctuation">.</span>f_back <span class="token keyword">and</span> f<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back \
            <span class="token keyword">and</span> f<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_code <span class="token operator">==</span> f<span class="token punctuation">.</span>f_code<span class="token punctuation">:</span>
            <span class="token comment"># 抛出异常</span>
            <span class="token keyword">raise</span> TailRecurseException<span class="token punctuation">(</span>args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> g<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
                <span class="token keyword">except</span> TailRecurseException<span class="token punctuation">,</span> e<span class="token punctuation">:</span>
                    args <span class="token operator">=</span> e<span class="token punctuation">.</span>args
                    kwargs <span class="token operator">=</span> e<span class="token punctuation">.</span>kwargs
    func<span class="token punctuation">.</span>__doc__ <span class="token operator">=</span> g<span class="token punctuation">.</span>__doc__
    <span class="token keyword">return</span> func

@tail_call_optimized
<span class="token keyword">def</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> acc<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;calculate a factorial&quot;</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> acc
    <span class="token keyword">return</span> factorial<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token operator">*</span>acc<span class="token punctuation">)</span>

<span class="token keyword">print</span> factorial<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span> 
</code></pre></div><p><a href="http://code.activestate.com/recipes/474088-tail-call-optimization-decorator/" target="_blank" rel="noopener noreferrer">http://code.activestate.com/recipes/474088-tail-call-optimization-decorator/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>↑原文,评论区也很精彩</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/markdown-note/assets/js/app.fdab574b.js" defer></script><script src="/markdown-note/assets/js/38.9b6814a4.js" defer></script>
  </body>
</html>
