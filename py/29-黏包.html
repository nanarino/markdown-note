<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>黏包 | nanarino note</title>
    <meta name="description" content="a note I took with markdown">
    
    
    <link rel="preload" href="/markdown-note/assets/css/0.styles.447f505d.css" as="style"><link rel="preload" href="/markdown-note/assets/js/app.9fff5c40.js" as="script"><link rel="preload" href="/markdown-note/assets/js/3.249571e8.js" as="script"><link rel="prefetch" href="/markdown-note/assets/js/10.8e85cf15.js"><link rel="prefetch" href="/markdown-note/assets/js/11.befe4248.js"><link rel="prefetch" href="/markdown-note/assets/js/12.f7cd383b.js"><link rel="prefetch" href="/markdown-note/assets/js/13.38cbb14c.js"><link rel="prefetch" href="/markdown-note/assets/js/14.26e3e81e.js"><link rel="prefetch" href="/markdown-note/assets/js/15.f1b6bea3.js"><link rel="prefetch" href="/markdown-note/assets/js/16.f091bb8c.js"><link rel="prefetch" href="/markdown-note/assets/js/17.7a22d023.js"><link rel="prefetch" href="/markdown-note/assets/js/18.59b1f62a.js"><link rel="prefetch" href="/markdown-note/assets/js/19.cb7d8146.js"><link rel="prefetch" href="/markdown-note/assets/js/2.11da7a94.js"><link rel="prefetch" href="/markdown-note/assets/js/20.f0242daa.js"><link rel="prefetch" href="/markdown-note/assets/js/21.fa3ba5da.js"><link rel="prefetch" href="/markdown-note/assets/js/22.283e00bb.js"><link rel="prefetch" href="/markdown-note/assets/js/23.b7f0dbb3.js"><link rel="prefetch" href="/markdown-note/assets/js/24.b86f4a34.js"><link rel="prefetch" href="/markdown-note/assets/js/25.d47e5e80.js"><link rel="prefetch" href="/markdown-note/assets/js/26.6343ad88.js"><link rel="prefetch" href="/markdown-note/assets/js/27.f80a9d63.js"><link rel="prefetch" href="/markdown-note/assets/js/28.e362d19f.js"><link rel="prefetch" href="/markdown-note/assets/js/29.c5218ff0.js"><link rel="prefetch" href="/markdown-note/assets/js/30.a3490c46.js"><link rel="prefetch" href="/markdown-note/assets/js/31.2979d13e.js"><link rel="prefetch" href="/markdown-note/assets/js/32.82662b5c.js"><link rel="prefetch" href="/markdown-note/assets/js/33.4a70e37b.js"><link rel="prefetch" href="/markdown-note/assets/js/34.a3c4dafe.js"><link rel="prefetch" href="/markdown-note/assets/js/35.7d587dfb.js"><link rel="prefetch" href="/markdown-note/assets/js/36.9ec3bd61.js"><link rel="prefetch" href="/markdown-note/assets/js/37.103149b3.js"><link rel="prefetch" href="/markdown-note/assets/js/38.d6389bc9.js"><link rel="prefetch" href="/markdown-note/assets/js/39.b9ab678c.js"><link rel="prefetch" href="/markdown-note/assets/js/4.ac9f756f.js"><link rel="prefetch" href="/markdown-note/assets/js/40.de345d62.js"><link rel="prefetch" href="/markdown-note/assets/js/41.6499a4c4.js"><link rel="prefetch" href="/markdown-note/assets/js/42.e11ba283.js"><link rel="prefetch" href="/markdown-note/assets/js/43.81c4f6aa.js"><link rel="prefetch" href="/markdown-note/assets/js/44.598b051d.js"><link rel="prefetch" href="/markdown-note/assets/js/45.42f48a17.js"><link rel="prefetch" href="/markdown-note/assets/js/46.a4162e31.js"><link rel="prefetch" href="/markdown-note/assets/js/47.c321268b.js"><link rel="prefetch" href="/markdown-note/assets/js/48.96d0bf0d.js"><link rel="prefetch" href="/markdown-note/assets/js/49.8de7548c.js"><link rel="prefetch" href="/markdown-note/assets/js/5.8faa297c.js"><link rel="prefetch" href="/markdown-note/assets/js/50.01ff550c.js"><link rel="prefetch" href="/markdown-note/assets/js/51.7e319c9b.js"><link rel="prefetch" href="/markdown-note/assets/js/52.df096cdd.js"><link rel="prefetch" href="/markdown-note/assets/js/53.9396bb72.js"><link rel="prefetch" href="/markdown-note/assets/js/54.409865cc.js"><link rel="prefetch" href="/markdown-note/assets/js/55.32589aeb.js"><link rel="prefetch" href="/markdown-note/assets/js/56.4efbb75f.js"><link rel="prefetch" href="/markdown-note/assets/js/57.c47847a9.js"><link rel="prefetch" href="/markdown-note/assets/js/58.b8f2f9cb.js"><link rel="prefetch" href="/markdown-note/assets/js/59.dec67bd6.js"><link rel="prefetch" href="/markdown-note/assets/js/6.3fa7f94b.js"><link rel="prefetch" href="/markdown-note/assets/js/60.728ce7a4.js"><link rel="prefetch" href="/markdown-note/assets/js/7.9218be4d.js"><link rel="prefetch" href="/markdown-note/assets/js/8.3269e16e.js"><link rel="prefetch" href="/markdown-note/assets/js/9.1b085dce.js">
    <link rel="stylesheet" href="/markdown-note/assets/css/0.styles.447f505d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/markdown-note/" class="home-link router-link-active"><!----> <span class="site-name">nanarino note</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/markdown-note/js/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/markdown-note/py/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/nanarino/markdown-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.akokono.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mysite
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/markdown-note/js/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/markdown-note/py/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/nanarino/markdown-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.akokono.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mysite
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>起步</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据类型</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>函数</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>常用模块</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面向对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>网络编程</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/markdown-note/py/27-网络编程基础.html" class="sidebar-link">补课:计算机网络</a></li><li><a href="/markdown-note/py/28-套接字socket.html" class="sidebar-link">套接字（socket）</a></li><li><a href="/markdown-note/py/29-黏包.html" class="active sidebar-link">黏包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/markdown-note/py/29-黏包.html#黏包成因" class="sidebar-link">黏包成因</a></li><li class="sidebar-sub-header"><a href="/markdown-note/py/29-黏包.html#黏包的解决方案" class="sidebar-link">黏包的解决方案</a></li><li class="sidebar-sub-header"><a href="/markdown-note/py/29-黏包.html#ftp作业：上传下载文件" class="sidebar-link">FTP作业：上传下载文件</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="黏包"><a href="#黏包" aria-hidden="true" class="header-anchor">#</a> 黏包</h1> <p>现象 : 同时执行多条命令之后，得到的结果很可能只有一部分，在执行其他命令的时候又接收到之前执行的另外一部分结果，这种显现就是黏包。</p> <h2 id="黏包成因"><a href="#黏包成因" aria-hidden="true" class="header-anchor">#</a> 黏包成因</h2> <h5 id="tcp协议的拆包机制"><a href="#tcp协议的拆包机制" aria-hidden="true" class="header-anchor">#</a> tcp协议的拆包机制</h5> <div class="language- extra-class"><pre class="language-text"><code>当发送端缓冲区的长度大于网卡的MTU时，tcp会将这次发送的数据拆成几个数据包发送出去。 
MTU是Maximum Transmission Unit的缩写。意思是网络上传送的最大数据包。MTU的单位是字节。 大部分网络设备的MTU都是1500。如果本机的MTU比网关的MTU大，大的数据包就会被拆开来传送，这样会产生很多数据包碎片，增加丢包率，降低网络速度
</code></pre></div><h5 id="面向流的通信特点和nagle算法"><a href="#面向流的通信特点和nagle算法" aria-hidden="true" class="header-anchor">#</a> 面向流的通信特点和Nagle算法</h5> <div class="language- extra-class"><pre class="language-text"><code>TCP（transport control protocol，传输控制协议）是面向连接的，面向流的，提供高可靠性服务。
收发两端（客户端和服务器端）都要有一一成对的socket，因此，发送端为了将多个发往接收端的包，更有效的发到对方，使用了优化方法（Nagle算法），将多次间隔较小且数据量小的数据，合并成一个大的数据块，然后进行封包。
这样，接收端，就难于分辨出来了，必须提供科学的拆包机制。 即面向流的通信是无消息保护边界的。 
对于空消息：tcp是基于数据流的，于是收发的消息不能为空，这就需要在客户端和服务端都添加空消息的处理机制，防止程序卡住，而udp是基于数据报的，即便是你输入的是空内容（直接回车），也可以被发送，udp协议会帮你封装上消息头发送过去。 
可靠黏包的tcp协议：tcp的协议数据不会丢，没有收完包，下次接收，会继续上次继续接收，己端总是在收到ack时才会清除缓冲区内容。数据是可靠的，但是会粘包。
</code></pre></div><h4 id="基于tcp协议特点的黏包现象成因"><a href="#基于tcp协议特点的黏包现象成因" aria-hidden="true" class="header-anchor">#</a> <strong>基于tcp协议特点的黏包现象成因</strong></h4> <p><img src="/markdown-note/assets/img/sp1.2b7b9496.png" alt="img"></p> <div class="language- extra-class"><pre class="language-text"><code>socket数据传输过程中的用户态与内核态说明:
发送端可以是一K一K地发送数据，而接收端的应用程序可以两K两K地提走数据，当然也有可能一次提走3K或6K数据，或者一次只提走几个字节的数据。
也就是说，应用程序所看到的数据是一个整体，或说是一个流（stream），一条消息有多少字节对应用程序是不可见的，因此TCP协议是面向流的协议，这也是容易出现粘包问题的原因。
而UDP是面向消息的协议，每个UDP段都是一条消息，应用程序必须以消息为单位提取数据，不能一次提取任意字节的数据，这一点和TCP是很不同的。
怎样定义消息呢？可以认为对方一次性write/send的数据为一个消息，需要明白的是当对方send一条信息的时候，无论底层怎样分段分片，TCP协议层会把构成整条消息的数据段排序完成后才呈现在内核缓冲区。
</code></pre></div><p>例如基于tcp的套接字客户端往服务端上传文件，发送时文件内容是按照一段一段的字节流发送的，在接收方看了，根本不知道该文件的字节流从何处开始，在何处结束</p> <p>此外，发送方引起的粘包是由TCP协议本身造成的，TCP为提高传输效率，发送方往往要收集到足够多的数据后才发送一个TCP段。若连续几次需要send的数据都很少，通常TCP会根据优化算法把这些数据合成一个TCP段后一次发送出去，这样接收方就收到了粘包数据。</p> <h3 id="udp不会发生黏包"><a href="#udp不会发生黏包" aria-hidden="true" class="header-anchor">#</a> UDP不会发生黏包</h3> <div class="language- extra-class"><pre class="language-text"><code>UDP（user datagram protocol，用户数据报协议）是无连接的，面向消息的，提供高效率服务。 
不会使用块的合并优化算法，, 由于UDP支持的是一对多的模式，所以接收端的skbuff(套接字缓冲区）采用了链式结构来记录每一个到达的UDP包，在每个UDP包中就有了消息头（消息来源地址，端口等信息），这样，对于接收端来说，就容易进行区分处理了。 即面向消息的通信是有消息保护边界的。 
对于空消息：tcp是基于数据流的，于是收发的消息不能为空，这就需要在客户端和服务端都添加空消息的处理机制，防止程序卡住，而udp是基于数据报的，即便是你输入的是空内容（直接回车），也可以被发送，udp协议会帮你封装上消息头发送过去。 
不可靠不黏包的udp协议：udp的recvfrom是阻塞的，一个recvfrom(x)必须对唯一一个sendinto(y),收完了x个字节的数据就算完成,若是y;x数据就丢失，这意味着udp根本不会粘包，但是会丢数据，不可靠。
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>udp和tcp一次发送数据长度的限制:
    用UDP协议发送时，用sendto函数最大能发送数据的长度为：65535- IP头(20) – UDP头(8)＝65507字节。用sendto函数发送数据时，如果发送数据长度大于该值，则函数会返回错误。（丢弃这个包，不进行发送） 

    用TCP协议发送时，由于TCP是数据流协议，因此不存在包大小的限制（暂不考虑缓冲区的大小），这是指在用send函数时，数据长度参数不受限制。而实际上，所指定的这段数据并不一定会一次性发送出去，如果这段数据比较长，会被分段发送，如果比较短，可能会等待和下一次数据一起发送。
</code></pre></div><h3 id="会发生黏包的两种情况"><a href="#会发生黏包的两种情况" aria-hidden="true" class="header-anchor">#</a> 会发生黏包的两种情况</h3> <h5 id="情况一-发送方的缓存机制"><a href="#情况一-发送方的缓存机制" aria-hidden="true" class="header-anchor">#</a> 情况一 发送方的缓存机制</h5> <p>发送端需要等缓冲区满才发送出去，造成黏包（发送数据时间间隔很短，数据了很小，会合到一起，产生黏包）</p> <h5 id="情况二-接收方的缓存机制"><a href="#情况二-接收方的缓存机制" aria-hidden="true" class="header-anchor">#</a> 情况二 接收方的缓存机制</h5> <p>接收方不及时接收缓冲区的包，造成多个包接收（客户端发送了一段数据，服务端只收了一小部分，服务端下次再收的时候还是从缓冲区拿上次遗留的数据，产生黏包）</p> <h2 id="黏包的解决方案"><a href="#黏包的解决方案" aria-hidden="true" class="header-anchor">#</a> 黏包的解决方案</h2> <h5 id="解决方案一"><a href="#解决方案一" aria-hidden="true" class="header-anchor">#</a> 解决方案一</h5> <p>问题的根源在于，接收端不知道发送端将要传送的字节流的长度，所以解决粘包的方法就是围绕，如何让发送端在发送数据前，把自己将要发送的字节流总大小让接收端知晓，然后接收端来一个死循环接收完所有数据。</p> <p><img src="/markdown-note/assets/img/sp2.6a648c49.png" alt="img"></p> <p>服务端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
<span class="token keyword">import</span> socket<span class="token punctuation">,</span>subprocess
ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span>
s<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>ip_port<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span>addr<span class="token operator">=</span>s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'客户端'</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        msg<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> msg<span class="token punctuation">:</span><span class="token keyword">break</span>
        res<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>\
                            stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\
                         stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\
                         stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
        err<span class="token operator">=</span>res<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err<span class="token punctuation">:</span>
            ret<span class="token operator">=</span>err
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ret<span class="token operator">=</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        data_length<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>data_length<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">'recv_ready'</span><span class="token punctuation">:</span>
            conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>客户端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
<span class="token keyword">import</span> socket<span class="token punctuation">,</span>time
s<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
res<span class="token operator">=</span>s<span class="token punctuation">.</span>connect_ex<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    msg<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token keyword">continue</span>
    <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">'quit'</span><span class="token punctuation">:</span><span class="token keyword">break</span>

    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    length<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'recv_ready'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    send_size<span class="token operator">=</span><span class="token number">0</span>
    recv_size<span class="token operator">=</span><span class="token number">0</span>
    data<span class="token operator">=</span><span class="token string">b''</span>
    <span class="token keyword">while</span> recv_size <span class="token operator">&lt;</span> length<span class="token punctuation">:</span>
        data<span class="token operator">+=</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        recv_size<span class="token operator">+=</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>存在的问题：
程序的运行速度远快于网络传输速度，所以在发送一段字节前，先用send去发送该字节流长度，这种方式会放大网络延迟带来的性能损耗
</code></pre></div><h5 id="解决方案进阶"><a href="#解决方案进阶" aria-hidden="true" class="header-anchor">#</a> 解决方案进阶</h5> <p>刚刚的方法，问题在于我们我们在发送</p> <p>我们可以借助一个模块，这个模块可以把要发送的数据长度转换成固定长度的字节。这样客户端每次接收消息之前只要先接受这个固定长度字节的内容看一看接下来要接收的信息大小，那么最终接受的数据只要达到这个值就停止，就能刚好不多不少的接收完整的数据了。</p> <h4 id="struct模块"><a href="#struct模块" aria-hidden="true" class="header-anchor">#</a> struct模块</h4> <p>该模块可以把一个类型，如数字，转成固定长度的bytes</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token number">1111111111111</span><span class="token punctuation">)</span>

struct<span class="token punctuation">.</span>error<span class="token punctuation">:</span> <span class="token string">'i'</span> <span class="token builtin">format</span> requires <span class="token operator">-</span><span class="token number">2147483648</span> <span class="token operator">&lt;=</span> number <span class="token operator">&lt;=</span> <span class="token number">2147483647</span> <span class="token comment">#这个是范围</span>
</code></pre></div><p><img src="/markdown-note/assets/img/sp3.c7289986.png" alt="img"></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> json<span class="token punctuation">,</span>struct
<span class="token comment">#假设通过客户端上传1T:1073741824000的文件a.txt</span>

<span class="token comment">#为避免粘包,必须自定制报头</span>
header<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'file_size'</span><span class="token punctuation">:</span><span class="token number">1073741824000</span><span class="token punctuation">,</span><span class="token string">'file_name'</span><span class="token punctuation">:</span><span class="token string">'/a/b/c/d/e/a.txt'</span><span class="token punctuation">,</span><span class="token string">'md5'</span><span class="token punctuation">:</span><span class="token string">'8f6fbf8347faa4924a76856701edb0f3'</span><span class="token punctuation">}</span> <span class="token comment">#1T数据,文件路径和md5值</span>

<span class="token comment">#为了该报头能传送,需要序列化并且转为bytes</span>
head_bytes<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token comment">#序列化并转成bytes,用于传输</span>

<span class="token comment">#为了让客户端知道报头的长度,用struck将报头长度这个数字转成固定长度:4个字节</span>
head_len_bytes<span class="token operator">=</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>head_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#这4个字节里只包含了一个数字,该数字是报头的长度</span>

<span class="token comment">#客户端开始发送</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>head_len_bytes<span class="token punctuation">)</span> <span class="token comment">#先发报头的长度,4个bytes</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>head_bytes<span class="token punctuation">)</span> <span class="token comment">#再发报头的字节格式</span>
conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>文件内容<span class="token punctuation">)</span> <span class="token comment">#然后发真实内容的字节格式</span>

<span class="token comment">#服务端开始接收</span>
head_len_bytes<span class="token operator">=</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">#先收报头4个bytes,得到报头长度的字节格式</span>
x<span class="token operator">=</span>struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span>head_len_bytes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">#提取报头的长度</span>

head_bytes<span class="token operator">=</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">#按照报头长度x,收取报头的bytes格式</span>
header<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#提取报头</span>

<span class="token comment">#最后根据报头的内容提取真实的数据,比如</span>
real_data_len<span class="token operator">=</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>header<span class="token punctuation">[</span><span class="token string">'file_size'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>real_data_len<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
<span class="token comment">#http://www.cnblogs.com/coser/archive/2011/12/17/2291160.html</span>
__author__ <span class="token operator">=</span> <span class="token string">'Linhaifeng'</span>
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> ctypes

values1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.7</span><span class="token punctuation">)</span>
values2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'defg'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span>
s1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>Struct<span class="token punctuation">(</span><span class="token string">'I3sf'</span><span class="token punctuation">)</span>
s2 <span class="token operator">=</span> struct<span class="token punctuation">.</span>Struct<span class="token punctuation">(</span><span class="token string">'4sI'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span>size<span class="token punctuation">,</span>s2<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
prebuffer<span class="token operator">=</span>ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span>s1<span class="token punctuation">.</span>size<span class="token operator">+</span>s2<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Before : '</span><span class="token punctuation">,</span>binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>prebuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># t=binascii.hexlify('asdfaf'.encode('utf-8'))</span>
<span class="token comment"># print(t)</span>


s1<span class="token punctuation">.</span>pack_into<span class="token punctuation">(</span>prebuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">*</span>values1<span class="token punctuation">)</span>
s2<span class="token punctuation">.</span>pack_into<span class="token punctuation">(</span>prebuffer<span class="token punctuation">,</span>s1<span class="token punctuation">.</span>size<span class="token punctuation">,</span><span class="token operator">*</span>values2<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After pack'</span><span class="token punctuation">,</span>binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>prebuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span>prebuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s2<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span>prebuffer<span class="token punctuation">,</span>s1<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

s3<span class="token operator">=</span>struct<span class="token punctuation">.</span>Struct<span class="token punctuation">(</span><span class="token string">'ii'</span><span class="token punctuation">)</span>
s3<span class="token punctuation">.</span>pack_into<span class="token punctuation">(</span>prebuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token number">123</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After pack'</span><span class="token punctuation">,</span>binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>prebuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s3<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span>prebuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="使用struct解决黏包"><a href="#使用struct解决黏包" aria-hidden="true" class="header-anchor">#</a> 使用struct解决黏包</h4> <p>借助struct模块，我们知道长度数字可以被转换成一个标准大小的4字节数字。因此可以利用这个特点来预先发送数据长度。</p> <table><thead><tr><th>发送时</th> <th>接收时</th></tr></thead> <tbody><tr><td>先发送struct转换好的数据长度4字节</td> <td>先接受4个字节使用struct转换成数字来获取要接收的数据长度</td></tr> <tr><td>再发送数据</td> <td>再按照长度接收数据</td></tr></tbody></table> <p>服务端（自定制报头）</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket<span class="token punctuation">,</span>struct<span class="token punctuation">,</span>json
<span class="token keyword">import</span> subprocess
phone<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
phone<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#就是它，在bind前加</span>

phone<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

phone<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span>addr<span class="token operator">=</span>phone<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        cmd<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> cmd<span class="token punctuation">:</span><span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'cmd: %s'</span> <span class="token operator">%</span>cmd<span class="token punctuation">)</span>

        res<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                             stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
                             stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
        err<span class="token operator">=</span>res<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err<span class="token punctuation">:</span>
            back_msg<span class="token operator">=</span>err
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            back_msg<span class="token operator">=</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>back_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#先发back_msg的长度</span>
        conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>back_msg<span class="token punctuation">)</span> <span class="token comment">#在发真实的内容</span>

    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>客户端（自定制报头）</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#_*_coding:utf-8_*_</span>
<span class="token keyword">import</span> socket<span class="token punctuation">,</span>time<span class="token punctuation">,</span>struct

s<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
res<span class="token operator">=</span>s<span class="token punctuation">.</span>connect_ex<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    msg<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token keyword">continue</span>
    <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">'quit'</span><span class="token punctuation">:</span><span class="token keyword">break</span>

    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>



    l<span class="token operator">=</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    x<span class="token operator">=</span>struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span>
    <span class="token comment"># print(struct.unpack('I',l))</span>
    r_s<span class="token operator">=</span><span class="token number">0</span>
    data<span class="token operator">=</span><span class="token string">b''</span>
    <span class="token keyword">while</span> r_s <span class="token operator">&lt;</span> x<span class="token punctuation">:</span>
        r_d<span class="token operator">=</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        data<span class="token operator">+=</span>r_d
        r_s<span class="token operator">+=</span><span class="token builtin">len</span><span class="token punctuation">(</span>r_d<span class="token punctuation">)</span>

    <span class="token comment"># print(data.decode('utf-8'))</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#windows默认gbk编码</span>
</code></pre></div><p>我们还可以把报头做成字典，字典里包含将要发送的真实数据的详细信息，然后json序列化，然后用struck将序列化后的数据长度打包成4个字节（4个自己足够用了）</p> <table><thead><tr><th>发送时</th> <th>接收时</th></tr></thead> <tbody><tr><td>先发报头长度</td> <td>先收报头长度，用struct取出来</td></tr> <tr><td>再编码报头内容然后发送</td> <td>根据取出的长度收取报头内容，然后解码，反序列化</td></tr> <tr><td>最后发真实内容</td> <td>从反序列化的结果中取出待取数据的详细信息，然后去取真实的数据内容</td></tr></tbody></table> <p>服务端：定制稍微复杂一点的报头</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket<span class="token punctuation">,</span>struct<span class="token punctuation">,</span>json
<span class="token keyword">import</span> subprocess
phone<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
phone<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#就是它，在bind前加</span>

phone<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

phone<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span>addr<span class="token operator">=</span>phone<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        cmd<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> cmd<span class="token punctuation">:</span><span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'cmd: %s'</span> <span class="token operator">%</span>cmd<span class="token punctuation">)</span>

        res<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                             stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
                             stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
        err<span class="token operator">=</span>res<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err<span class="token punctuation">:</span>
            back_msg<span class="token operator">=</span>err
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            back_msg<span class="token operator">=</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'data_size'</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>back_msg<span class="token punctuation">)</span><span class="token punctuation">}</span>
        head_json<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
        head_json_bytes<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>head_json<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>head_json_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#先发报头的长度</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>head_json_bytes<span class="token punctuation">)</span> <span class="token comment">#再发报头</span>
        conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>back_msg<span class="token punctuation">)</span> <span class="token comment">#在发真实的内容</span>

    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>客户端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> struct<span class="token punctuation">,</span>json

ip_port<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span>
client<span class="token operator">=</span>socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">)</span>
client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>ip_port<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    cmd<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;: '</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cmd<span class="token punctuation">:</span><span class="token keyword">continue</span>
    client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    head<span class="token operator">=</span>client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    head_json_len<span class="token operator">=</span>struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span>head<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    head_json<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>head_json_len<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data_len<span class="token operator">=</span>head_json<span class="token punctuation">[</span><span class="token string">'data_size'</span><span class="token punctuation">]</span>

    recv_size<span class="token operator">=</span><span class="token number">0</span>
    recv_data<span class="token operator">=</span><span class="token string">b''</span>
    <span class="token keyword">while</span> recv_size <span class="token operator">&lt;</span> data_len<span class="token punctuation">:</span>
        recv_data<span class="token operator">+=</span>client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        recv_size<span class="token operator">+=</span><span class="token builtin">len</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#print(recv_data.decode('gbk')) #windows默认gbk编码</span>
</code></pre></div><h2 id="ftp作业：上传下载文件"><a href="#ftp作业：上传下载文件" aria-hidden="true" class="header-anchor">#</a> FTP作业：上传下载文件</h2> <p>服务端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> json
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> os

<span class="token keyword">class</span> <span class="token class-name">MYTCPServer</span><span class="token punctuation">:</span>
    address_family <span class="token operator">=</span> socket<span class="token punctuation">.</span>AF_INET

    socket_type <span class="token operator">=</span> socket<span class="token punctuation">.</span>SOCK_STREAM

    allow_reuse_address <span class="token operator">=</span> <span class="token boolean">False</span>

    max_packet_size <span class="token operator">=</span> <span class="token number">8192</span>

    coding<span class="token operator">=</span><span class="token string">'utf-8'</span>

    request_queue_size <span class="token operator">=</span> <span class="token number">5</span>

    server_dir<span class="token operator">=</span><span class="token string">'file_upload'</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> server_address<span class="token punctuation">,</span> bind_and_activate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Constructor.  May be extended, do not override.&quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>server_address<span class="token operator">=</span>server_address
        self<span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>self<span class="token punctuation">.</span>address_family<span class="token punctuation">,</span>
                                    self<span class="token punctuation">.</span>socket_type<span class="token punctuation">)</span>
        <span class="token keyword">if</span> bind_and_activate<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>server_bind<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>server_activate<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>server_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span>

    <span class="token keyword">def</span> <span class="token function">server_bind</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Called by constructor to bind the socket.
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>allow_reuse_address<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>self<span class="token punctuation">.</span>server_address<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>server_address <span class="token operator">=</span> self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>getsockname<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">server_activate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Called by constructor to activate the server.
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request_queue_size<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">server_close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Called to clean-up the server.
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Get the request and client address from the socket.
        &quot;&quot;&quot;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">close_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Called to clean up an individual request.&quot;&quot;&quot;</span>
        request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">,</span>self<span class="token punctuation">.</span>client_addr<span class="token operator">=</span>self<span class="token punctuation">.</span>get_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'from client '</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>client_addr<span class="token punctuation">)</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    head_struct <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> head_struct<span class="token punctuation">:</span><span class="token keyword">break</span>

                    head_len <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> head_struct<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    head_json <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>head_len<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>self<span class="token punctuation">.</span>coding<span class="token punctuation">)</span>
                    head_dic <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>head_json<span class="token punctuation">)</span>

                    <span class="token keyword">print</span><span class="token punctuation">(</span>head_dic<span class="token punctuation">)</span>
                    <span class="token comment">#head_dic={'cmd':'put','filename':'a.txt','filesize':123123}</span>
                    cmd<span class="token operator">=</span>head_dic<span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        func<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>
                        func<span class="token punctuation">(</span>head_dic<span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>

    <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        file_path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>normpath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>server_dir<span class="token punctuation">,</span>
            args<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>

        filesize<span class="token operator">=</span>args<span class="token punctuation">[</span><span class="token string">'filesize'</span><span class="token punctuation">]</span>
        recv_size<span class="token operator">=</span><span class="token number">0</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-----&gt;'</span><span class="token punctuation">,</span>file_path<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">while</span> recv_size <span class="token operator">&lt;</span> filesize<span class="token punctuation">:</span>
                recv_data<span class="token operator">=</span>self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_packet_size<span class="token punctuation">)</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>recv_data<span class="token punctuation">)</span>
                recv_size<span class="token operator">+=</span><span class="token builtin">len</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'recvsize:%s filesize:%s'</span> <span class="token operator">%</span><span class="token punctuation">(</span>recv_size<span class="token punctuation">,</span>filesize<span class="token punctuation">)</span><span class="token punctuation">)</span>


tcpserver1<span class="token operator">=</span>MYTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

tcpserver1<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>






<span class="token comment">#下列代码与本题无关</span>
<span class="token keyword">class</span> <span class="token class-name">MYUDPServer</span><span class="token punctuation">:</span>

    <span class="token triple-quoted-string string">&quot;&quot;&quot;UDP server class.&quot;&quot;&quot;</span>
    address_family <span class="token operator">=</span> socket<span class="token punctuation">.</span>AF_INET

    socket_type <span class="token operator">=</span> socket<span class="token punctuation">.</span>SOCK_DGRAM

    allow_reuse_address <span class="token operator">=</span> <span class="token boolean">False</span>

    max_packet_size <span class="token operator">=</span> <span class="token number">8192</span>

    coding<span class="token operator">=</span><span class="token string">'utf-8'</span>

    <span class="token keyword">def</span> <span class="token function">get_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_packet_size<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> self<span class="token punctuation">.</span>socket<span class="token punctuation">)</span><span class="token punctuation">,</span> client_addr

    <span class="token keyword">def</span> <span class="token function">server_activate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># No need to call listen() for UDP.</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">shutdown_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># No need to shutdown anything.</span>
        self<span class="token punctuation">.</span>close_request<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">close_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># No need to close anything.</span>
        <span class="token keyword">pass</span>
</code></pre></div><p>客户端</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os



<span class="token keyword">class</span> <span class="token class-name">MYTCPClient</span><span class="token punctuation">:</span>
    address_family <span class="token operator">=</span> socket<span class="token punctuation">.</span>AF_INET

    socket_type <span class="token operator">=</span> socket<span class="token punctuation">.</span>SOCK_STREAM

    allow_reuse_address <span class="token operator">=</span> <span class="token boolean">False</span>

    max_packet_size <span class="token operator">=</span> <span class="token number">8192</span>

    coding<span class="token operator">=</span><span class="token string">'utf-8'</span>

    request_queue_size <span class="token operator">=</span> <span class="token number">5</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> server_address<span class="token punctuation">,</span> connect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>server_address<span class="token operator">=</span>server_address
        self<span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>self<span class="token punctuation">.</span>address_family<span class="token punctuation">,</span>
                                    self<span class="token punctuation">.</span>socket_type<span class="token punctuation">)</span>
        <span class="token keyword">if</span> connect<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>client_connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>client_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span>

    <span class="token keyword">def</span> <span class="token function">client_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>server_address<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">client_close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            inp<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> inp<span class="token punctuation">:</span><span class="token keyword">continue</span>
            l<span class="token operator">=</span>inp<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
            cmd<span class="token operator">=</span>l<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
                func<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>
                func<span class="token punctuation">(</span>l<span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cmd<span class="token operator">=</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        filename<span class="token operator">=</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'file:%s is not exists'</span> <span class="token operator">%</span>filename<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            filesize<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>

        head_dic<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'cmd'</span><span class="token punctuation">:</span>cmd<span class="token punctuation">,</span><span class="token string">'filename'</span><span class="token punctuation">:</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'filesize'</span><span class="token punctuation">:</span>filesize<span class="token punctuation">}</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>head_dic<span class="token punctuation">)</span>
        head_json<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>head_dic<span class="token punctuation">)</span>
        head_json_bytes<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>head_json<span class="token punctuation">,</span>encoding<span class="token operator">=</span>self<span class="token punctuation">.</span>coding<span class="token punctuation">)</span>

        head_struct<span class="token operator">=</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>head_json_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>head_struct<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>head_json_bytes<span class="token punctuation">)</span>
        send_size<span class="token operator">=</span><span class="token number">0</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                send_size<span class="token operator">+=</span><span class="token builtin">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>send_size<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'upload successful'</span><span class="token punctuation">)</span>




client<span class="token operator">=</span>MYTCPClient<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

client<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/markdown-note/assets/js/app.9fff5c40.js" defer></script><script src="/markdown-note/assets/js/3.249571e8.js" defer></script>
  </body>
</html>
